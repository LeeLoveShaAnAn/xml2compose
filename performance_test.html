<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¬æ¢å™¨æ€§èƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
        }
        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #007AFF;
        }
        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .btn {
            background: linear-gradient(135deg, #007AFF, #0056CC);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-group label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .input-group input, .input-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .chart {
            width: 100%;
            height: 300px;
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }
        .chart-bar {
            position: absolute;
            bottom: 0;
            background: linear-gradient(135deg, #007AFF, #0056CC);
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 5px;
            box-sizing: border-box;
        }
        .results-table {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }
        .table tr:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        .status-running {
            background: #cce5ff;
            color: #004085;
        }
        .progress-ring {
            width: 60px;
            height: 60px;
            margin: 0 auto;
        }
        .progress-ring-circle {
            fill: none;
            stroke: #007AFF;
            stroke-width: 4;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dasharray 0.3s ease;
        }
        .progress-ring-bg {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 4;
        }
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ XML2Compose è½¬æ¢å™¨æ€§èƒ½æµ‹è¯•</h1>
        
        <div class="controls">
            <div class="control-group">
                <div class="input-group">
                    <label>æµ‹è¯•è§„æ¨¡:</label>
                    <select id="test-scale">
                        <option value="small">å°è§„æ¨¡ (10ä¸ª)</option>
                        <option value="medium" selected>ä¸­ç­‰è§„æ¨¡ (50ä¸ª)</option>
                        <option value="large">å¤§è§„æ¨¡ (100ä¸ª)</option>
                        <option value="xl">è¶…å¤§è§„æ¨¡ (200ä¸ª)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>å¹¶å‘æ•°:</label>
                    <input type="number" id="concurrency" value="5" min="1" max="20">
                </div>
                <div class="input-group">
                    <label>å»¶è¿Ÿ (ms):</label>
                    <input type="number" id="delay" value="100" min="0" max="1000" step="50">
                </div>
            </div>
            
            <div class="control-group">
                <button class="btn" onclick="startPerformanceTest()" id="start-btn">ğŸš€ å¼€å§‹æ€§èƒ½æµ‹è¯•</button>
                <button class="btn btn-danger" onclick="stopTest()" id="stop-btn" disabled>â¹ï¸ åœæ­¢æµ‹è¯•</button>
                <button class="btn" onclick="clearResults()">ğŸ”„ æ¸…ç©ºç»“æœ</button>
                <button class="btn btn-success" onclick="exportResults()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>ğŸ“Š å®æ—¶æŒ‡æ ‡</h3>
                <div class="metric">
                    <span class="metric-label">æ€»æµ‹è¯•æ•°</span>
                    <span class="metric-value" id="total-tests">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">å·²å®Œæˆ</span>
                    <span class="metric-value" id="completed-tests">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æˆåŠŸç‡</span>
                    <span class="metric-value" id="success-rate">0%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">å¹³å‡è€—æ—¶</span>
                    <span class="metric-value" id="avg-time">0ms</span>
                </div>
            </div>

            <div class="card">
                <h3>âš¡ æ€§èƒ½æŒ‡æ ‡</h3>
                <div class="metric">
                    <span class="metric-label">æœ€å¿«è½¬æ¢</span>
                    <span class="metric-value" id="min-time">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æœ€æ…¢è½¬æ¢</span>
                    <span class="metric-value" id="max-time">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ååé‡</span>
                    <span class="metric-value" id="throughput">0 /s</span>
                </div>
                <div class="metric">
                    <span class="metric-label">å†…å­˜ä½¿ç”¨</span>
                    <span class="metric-value" id="memory-usage">-</span>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ¯ æµ‹è¯•è¿›åº¦</h3>
                <div style="text-align: center; margin-bottom: 15px;">
                    <svg class="progress-ring">
                        <circle class="progress-ring-bg" cx="30" cy="30" r="26"></circle>
                        <circle class="progress-ring-circle" cx="30" cy="30" r="26" id="progress-circle"></circle>
                    </svg>
                </div>
                <div class="metric">
                    <span class="metric-label">å½“å‰çŠ¶æ€</span>
                    <span class="metric-value" id="test-status">å°±ç»ª</span>
                </div>
                <div class="metric">
                    <span class="metric-label">å‰©ä½™æ—¶é—´</span>
                    <span class="metric-value" id="eta">-</span>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h3>
                <div class="metric">
                    <span class="metric-label">é”™è¯¯æ•°é‡</span>
                    <span class="metric-value" id="error-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">è¶…æ—¶æ•°é‡</span>
                    <span class="metric-value" id="timeout-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">P95 è€—æ—¶</span>
                    <span class="metric-value" id="p95-time">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">P99 è€—æ—¶</span>
                    <span class="metric-value" id="p99-time">-</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3>ğŸ“Š å“åº”æ—¶é—´åˆ†å¸ƒ</h3>
            <div class="chart" id="response-time-chart">
                <!-- å›¾è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <div class="results-table">
            <h3>ğŸ“‹ æµ‹è¯•ç»“æœè¯¦æƒ…</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>åºå·</th>
                        <th>æµ‹è¯•åç§°</th>
                        <th>çŠ¶æ€</th>
                        <th>è€—æ—¶ (ms)</th>
                        <th>XML å¤§å°</th>
                        <th>è¾“å‡ºå¤§å°</th>
                        <th>é”™è¯¯ä¿¡æ¯</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                    <!-- ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // æ€§èƒ½æµ‹è¯•æ•°æ®
        let testResults = [];
        let isRunning = false;
        let startTime = 0;
        let testConfig = {};

        // æµ‹è¯•ç”¨ä¾‹æ¨¡æ¿
        const testTemplates = [
            {
                name: 'ç®€å•æ–‡æœ¬',
                xml: '<TextView android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="Hello" />'
            },
            {
                name: 'çº¿æ€§å¸ƒå±€',
                xml: `<LinearLayout android:layout_width="match_parent" android:layout_height="match_parent" android:orientation="vertical">
                    <TextView android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="Title" />
                    <Button android:layout_width="match_parent" android:layout_height="wrap_content" android:text="Click" />
                </LinearLayout>`
            },
            {
                name: 'å¤æ‚è¡¨å•',
                xml: `<LinearLayout android:layout_width="match_parent" android:layout_height="match_parent" android:orientation="vertical" android:padding="16dp">
                    <TextView android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="ç”¨æˆ·ç™»å½•" android:textSize="24sp" />
                    <EditText android:layout_width="match_parent" android:layout_height="wrap_content" android:hint="ç”¨æˆ·å" />
                    <EditText android:layout_width="match_parent" android:layout_height="wrap_content" android:hint="å¯†ç " android:inputType="textPassword" />
                    <Button android:layout_width="match_parent" android:layout_height="wrap_content" android:text="ç™»å½•" />
                    <Button android:layout_width="match_parent" android:layout_height="wrap_content" android:text="æ³¨å†Œ" />
                </LinearLayout>`
            }
        ];

        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        function generateTestData(scale) {
            const counts = {
                small: 10,
                medium: 50,
                large: 100,
                xl: 200
            };
            
            const count = counts[scale] || 50;
            const tests = [];
            
            for (let i = 0; i < count; i++) {
                const template = testTemplates[i % testTemplates.length];
                tests.push({
                    id: `test-${i + 1}`,
                    name: `${template.name}-${i + 1}`,
                    xml: template.xml,
                    index: i + 1
                });
            }
            
            return tests;
        }

        // æ¨¡æ‹Ÿè½¬æ¢å™¨è°ƒç”¨
        async function simulateConversion(xml) {
            const delay = Math.random() * 200 + 50; // 50-250ms éšæœºå»¶è¿Ÿ
            
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (Math.random() < 0.95) { // 95% æˆåŠŸç‡
                        const output = `// è½¬æ¢ç»“æœ\nText("${xml.substring(0, 20)}...")\n`;
                        resolve(output);
                    } else {
                        reject(new Error('æ¨¡æ‹Ÿè½¬æ¢å¤±è´¥'));
                    }
                }, delay);
            });
        }

        // è¿è¡Œå•ä¸ªæµ‹è¯•
        async function runSingleTest(testCase) {
            const startTime = Date.now();
            
            try {
                const output = await simulateConversion(testCase.xml);
                const duration = Date.now() - startTime;
                
                return {
                    id: testCase.id,
                    name: testCase.name,
                    success: true,
                    duration: duration,
                    xmlSize: testCase.xml.length,
                    outputSize: output.length,
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                const duration = Date.now() - startTime;
                
                return {
                    id: testCase.id,
                    name: testCase.name,
                    success: false,
                    duration: duration,
                    xmlSize: testCase.xml.length,
                    outputSize: 0,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
            }
        }

        // æ›´æ–°å®æ—¶æŒ‡æ ‡
        function updateMetrics() {
            const total = testConfig.testData?.length || 0;
            const completed = testResults.length;
            const successful = testResults.filter(r => r.success).length;
            const successRate = completed > 0 ? Math.round((successful / completed) * 100) : 0;
            
            const durations = testResults.map(r => r.duration);
            const avgTime = durations.length > 0 ? Math.round(durations.reduce((a, b) => a + b, 0) / durations.length) : 0;
            const minTime = durations.length > 0 ? Math.min(...durations) : 0;
            const maxTime = durations.length > 0 ? Math.max(...durations) : 0;
            
            // è®¡ç®—ç™¾åˆ†ä½æ•°
            const sortedDurations = durations.sort((a, b) => a - b);
            const p95Index = Math.floor(sortedDurations.length * 0.95);
            const p99Index = Math.floor(sortedDurations.length * 0.99);
            const p95Time = sortedDurations[p95Index] || 0;
            const p99Time = sortedDurations[p99Index] || 0;
            
            // è®¡ç®—ååé‡
            const elapsedSeconds = (Date.now() - startTime) / 1000;
            const throughput = elapsedSeconds > 0 ? Math.round(completed / elapsedSeconds * 10) / 10 : 0;
            
            // æ›´æ–°DOM
            document.getElementById('total-tests').textContent = total;
            document.getElementById('completed-tests').textContent = completed;
            document.getElementById('success-rate').textContent = `${successRate}%`;
            document.getElementById('avg-time').textContent = `${avgTime}ms`;
            document.getElementById('min-time').textContent = minTime > 0 ? `${minTime}ms` : '-';
            document.getElementById('max-time').textContent = maxTime > 0 ? `${maxTime}ms` : '-';
            document.getElementById('throughput').textContent = `${throughput} /s`;
            document.getElementById('p95-time').textContent = p95Time > 0 ? `${p95Time}ms` : '-';
            document.getElementById('p99-time').textContent = p99Time > 0 ? `${p99Time}ms` : '-';
            
            const errorCount = testResults.filter(r => !r.success).length;
            document.getElementById('error-count').textContent = errorCount;
            
            // æ›´æ–°è¿›åº¦ç¯
            updateProgressRing(completed, total);
            
            // æ›´æ–°å›¾è¡¨
            updateChart();
            
            // æ›´æ–°è¡¨æ ¼
            updateResultsTable();
        }

        // æ›´æ–°è¿›åº¦ç¯
        function updateProgressRing(current, total) {
            const circle = document.getElementById('progress-circle');
            const radius = 26;
            const circumference = 2 * Math.PI * radius;
            
            const percentage = total > 0 ? (current / total) : 0;
            const offset = circumference - (percentage * circumference);
            
            circle.style.strokeDasharray = circumference;
            circle.style.strokeDashoffset = offset;
        }

        // æ›´æ–°å“åº”æ—¶é—´å›¾è¡¨
        function updateChart() {
            const chart = document.getElementById('response-time-chart');
            const durations = testResults.map(r => r.duration);
            
            if (durations.length === 0) return;
            
            // åˆ›å»ºç›´æ–¹å›¾æ•°æ®
            const buckets = 10;
            const minTime = Math.min(...durations);
            const maxTime = Math.max(...durations);
            const bucketSize = (maxTime - minTime) / buckets;
            
            const histogram = new Array(buckets).fill(0);
            durations.forEach(duration => {
                const bucketIndex = Math.min(Math.floor((duration - minTime) / bucketSize), buckets - 1);
                histogram[bucketIndex]++;
            });
            
            const maxCount = Math.max(...histogram);
            
            // æ¸…ç©ºå›¾è¡¨
            chart.innerHTML = '';
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            histogram.forEach((count, index) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.left = `${(index / buckets) * 100}%`;
                bar.style.width = `${100 / buckets}%`;
                bar.style.height = `${(count / maxCount) * 100}%`;
                bar.textContent = count;
                chart.appendChild(bar);
            });
        }

        // æ›´æ–°ç»“æœè¡¨æ ¼
        function updateResultsTable() {
            const tbody = document.getElementById('results-tbody');
            
            // åªæ˜¾ç¤ºæœ€è¿‘çš„20æ¡ç»“æœ
            const recentResults = testResults.slice(-20);
            
            tbody.innerHTML = recentResults.map(result => `
                <tr>
                    <td>${result.id.split('-')[1]}</td>
                    <td>${result.name}</td>
                    <td>
                        <span class="status-badge status-${result.success ? 'success' : 'failed'}">
                            ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}
                        </span>
                    </td>
                    <td>${result.duration}ms</td>
                    <td>${result.xmlSize} å­—ç¬¦</td>
                    <td>${result.outputSize} å­—ç¬¦</td>
                    <td>${result.error || '-'}</td>
                </tr>
            `).join('');
        }

        // å¼€å§‹æ€§èƒ½æµ‹è¯•
        async function startPerformanceTest() {
            if (isRunning) return;
            
            isRunning = true;
            testResults = [];
            startTime = Date.now();
            
            // è·å–é…ç½®
            const scale = document.getElementById('test-scale').value;
            const concurrency = parseInt(document.getElementById('concurrency').value);
            const delay = parseInt(document.getElementById('delay').value);
            
            testConfig = {
                scale,
                concurrency,
                delay,
                testData: generateTestData(scale)
            };
            
            // æ›´æ–°UI
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('test-status').textContent = 'è¿è¡Œä¸­';
            
            console.log(`å¼€å§‹æ€§èƒ½æµ‹è¯•: ${testConfig.testData.length} ä¸ªæµ‹è¯•ç”¨ä¾‹, å¹¶å‘æ•°: ${concurrency}`);
            
            try {
                // å¹¶å‘æ‰§è¡Œæµ‹è¯•
                const batches = [];
                for (let i = 0; i < testConfig.testData.length; i += concurrency) {
                    const batch = testConfig.testData.slice(i, i + concurrency);
                    batches.push(batch);
                }
                
                for (const batch of batches) {
                    if (!isRunning) break;
                    
                    const batchPromises = batch.map(testCase => runSingleTest(testCase));
                    const batchResults = await Promise.all(batchPromises);
                    
                    testResults.push(...batchResults);
                    updateMetrics();
                    
                    // æ·»åŠ å»¶è¿Ÿ
                    if (delay > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                
                // æµ‹è¯•å®Œæˆ
                document.getElementById('test-status').textContent = 'å®Œæˆ';
                console.log('æ€§èƒ½æµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                console.error('æ€§èƒ½æµ‹è¯•é”™è¯¯:', error);
                document.getElementById('test-status').textContent = 'é”™è¯¯';
            }
            
            // é‡ç½®UI
            isRunning = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
        }

        // åœæ­¢æµ‹è¯•
        function stopTest() {
            isRunning = false;
            document.getElementById('test-status').textContent = 'å·²åœæ­¢';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            testResults = [];
            updateMetrics();
            document.getElementById('test-status').textContent = 'å°±ç»ª';
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            const report = {
                timestamp: new Date().toISOString(),
                config: testConfig,
                summary: {
                    total: testConfig.testData?.length || 0,
                    completed: testResults.length,
                    successful: testResults.filter(r => r.success).length,
                    failed: testResults.filter(r => !r.success).length,
                    avgTime: testResults.length > 0 ? testResults.reduce((sum, r) => sum + r.duration, 0) / testResults.length : 0,
                    minTime: Math.min(...testResults.map(r => r.duration)),
                    maxTime: Math.max(...testResults.map(r => r.duration))
                },
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `performance_test_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ç›‘æ§å†…å­˜ä½¿ç”¨
        function monitorMemory() {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                const total = Math.round(performance.memory.totalJSHeapSize / 1024 / 1024);
                document.getElementById('memory-usage').textContent = `${used}/${total} MB`;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateMetrics();
            
            // å®šæœŸæ›´æ–°å†…å­˜ç›‘æ§
            setInterval(monitorMemory, 1000);
        });
    </script>
</body>
</html>
